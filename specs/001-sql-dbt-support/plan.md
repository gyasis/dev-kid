# Implementation Plan: SQL Pipeline & dbt Project Support

**Branch**: `001-sql-dbt-support` | **Date**: 2026-02-23 | **Spec**: [spec.md](spec.md)

## Summary

Extend dev-kid's Integration Sentinel and orchestrator to natively support SQL pipeline and dbt projects. Adds SQL schema diffing (detect breaking column changes between waves), dbt dependency graph wave planning (auto-order tasks from `ref()` DAG), SQL/dbt constitution rule enforcement (5 built-in rules), and SQL placeholder detection. Also updates speckit to generate DDL-style artifacts for SQL projects.

## Technical Context

**Language/Version**: Python 3.11 (same as dev-kid core)
**Primary Dependencies**: `sqlglot` 28.x (SQL parsing/AST), `PyYAML` (dbt schema.yml parsing); both optional with graceful fallback
**Storage**: Files — `.claude/schema_snapshots/wave_{N}_pre.json`, `target/manifest.json` (read-only), `.sql`, `.yml`
**Testing**: pytest (existing suite), new `tests/unit/sql/` and `tests/unit/dbt/` directories
**Target Platform**: Linux (same as dev-kid)
**Project Type**: Single project — extension of existing `cli/` structure
**Performance Goals**: SQL/dbt validation < 5 seconds for 200 dbt models at checkpoint
**Constraints**: sqlglot and PyYAML are optional; system degrades gracefully to regex-only if not installed. No mandatory new deps.
**Scale/Scope**: Handles dbt projects up to 500 models; SQL migration files up to 10,000 lines each

## Constitution Check

No project constitution exists yet. Gates: N/A.
Post-design check: no violations. Solution uses existing patterns (sentinel tier model, constitution_parser extension, wave executor hook points).

## Project Structure

### Documentation (this feature)

```text
specs/001-sql-dbt-support/
├── plan.md              ← this file
├── spec.md
├── research.md          ← SQL library decisions, manifest schema, snapshot strategy
├── data-model.md        ← entity definitions (DDL-style)
├── quickstart.md        ← test scenarios for each user story
├── contracts/
│   ├── sql_schema_diff.sql        ← pre/post wave snapshot interface
│   ├── dbt_dependency_graph.sql   ← manifest + regex fallback interface
│   └── sql_constitution_rules.sql ← 5 rule definitions with examples
└── tasks.md             ← generated by /speckit.tasks
```

### Source Code (repository root)

```text
cli/
├── dbt_graph.py                   ← NEW: DBTGraph — manifest.json + regex fallback
├── orchestrator.py                ← MODIFIED: dbt-aware wave assignment
├── sentinel/
│   ├── sql_schema_diff.py         ← NEW: DDLParser, SchemaSnapshot, SchemaDiff
│   ├── sql_constitution.py        ← NEW: SQLConstitutionScanner (5 built-in rules)
│   ├── placeholder_scanner.py     ← MODIFIED: add SQL/dbt placeholder patterns
│   ├── interface_diff.py          ← MODIFIED: route .sql files to sql_schema_diff
│   └── runner.py                  ← MODIFIED: integrate SQL validation into tier flow
└── wave_executor.py               ← MODIFIED: pre/post wave snapshot hooks

tests/
├── unit/
│   ├── sql/
│   │   ├── test_ddl_parser.py          ← DDLParser unit tests
│   │   ├── test_schema_diff.py         ← snapshot comparison tests
│   │   └── test_sql_constitution.py    ← rule enforcement tests
│   └── dbt/
│       ├── test_dbt_graph.py           ← manifest + regex fallback tests
│       └── test_dbt_wave_planning.py   ← wave assignment from DAG tests
└── integration/
    └── test_sql_dbt_e2e.py             ← end-to-end scenario tests
```

## Complexity Tracking

No constitution violations to justify.

## Implementation Phases

### Phase 1: SQL Schema Diff (US1 — P1)

New module: `cli/sentinel/sql_schema_diff.py`

Components:
1. **`DDLParser`** — parse CREATE TABLE DDL → column signatures using sqlglot (+ regex fallback)
2. **`SchemaSnapshot`** — capture pre-wave state from `git show HEAD:file`, persist to `.claude/schema_snapshots/`
3. **`SchemaDiff`** — compare pre/post snapshots → classify changes as breaking/non-breaking
4. **`AffectedModelFinder`** — given removed/changed column, scan dbt models for `ref()` + column usage

Integration points:
- `wave_executor.py`: call `SchemaSnapshot.capture_pre_wave()` before agent execution
- `wave_executor.py`: call `SchemaDiff.compare_post_wave()` in `verify_wave_completion()`
- `interface_diff.py`: route `.sql` files to `sql_schema_diff` instead of Python AST

### Phase 2: dbt Dependency Graph (US2 — P2)

New module: `cli/dbt_graph.py`

Components:
1. **`DBTGraph`** — loads from `target/manifest.json`; falls back to regex scanning of `models/`
2. **`DBTTopologicalSort`** — produces wave-level ordering from DAG
3. **`CycleDetector`** — Kahn's algorithm; reports cycle path on error

Integration points:
- `orchestrator.py`: after standard file-lock analysis, apply dbt dependency ordering
- Only activated when `dbt_project.yml` present in project root

### Phase 3: SQL/dbt Constitution Rules (US3 — P2)

New module: `cli/sentinel/sql_constitution.py`

Components:
1. **`SQLConstitutionScanner`** — scans `.sql` files via sqlglot AST + regex
2. **`DBTSchemaYAMLScanner`** — scans `.yml` files via PyYAML
3. Built-in rules: `NO_SELECT_STAR`, `MODEL_DESCRIPTION_REQUIRED`, `INCREMENTAL_NEEDS_UNIQUE_KEY`, `NO_HARDCODED_CREDENTIALS`, `MIGRATION_NEEDS_ROLLBACK`

Integration points:
- `constitution_parser.py`: register SQL file extensions and route to `SQLConstitutionScanner`
- `sentinel/runner.py`: existing Tier 1 scan includes SQL/YML files

### Phase 4: SQL Placeholder Detection (US3 — P3)

Modified module: `cli/sentinel/placeholder_scanner.py`

Add SQL placeholder patterns:
- `SELECT_ONE`: `^\s*SELECT\s+1\s*(?:AS\s+\w+\s*)?$`
- `TODO_COMMENT`: `--\s*(TODO|FIXME|STUB|PLACEHOLDER)`
- `EMPTY_REF`: `ref\s*\(\s*['"]{2}\s*\)`
- `STUB_MODEL`: model file is entirely a single `SELECT 1` expression

### Phase 5: Speckit SQL/dbt Artifacts (FR-013, FR-014)

Modified: speckit plan prompt instructions + `data-model.md` / `contracts/` generation

Detection heuristic: `dbt_project.yml` present → SQL/dbt mode
- `data-model.md` → DDL-style `CREATE TABLE` definitions
- `contracts/` → SQL DDL schemas (not OpenAPI)

## Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| SQL parser | sqlglot (optional dep) | Only full Python AST parser; supports all SQL dialects including Snowflake/BigQuery |
| Schema snapshot storage | `.claude/schema_snapshots/` JSON | Context-compression safe; consistent with existing `.claude/` state pattern |
| dbt graph source | manifest.json → regex fallback | manifest is authoritative; regex handles uncompiled projects |
| Jinja stripping | Regex pre-processing before sqlglot | Required — sqlglot cannot parse Jinja `{{ }}` tokens natively |
| Credential detection | Regex (not sqlglot) | Secret patterns are string-level; no AST needed |
| Dependency: sqlglot | Optional, graceful degradation | Preserves zero-mandatory-dependency philosophy |
