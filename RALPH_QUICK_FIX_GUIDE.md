# Ralph Optimization Quick Fix Guide

**For developers who want to fix the issues NOW**

Time required: 30 minutes
Difficulty: Easy (copy-paste + test)

---

## The One Critical Fix

**Problem**: Wave executor crashes with `FileNotFoundError: task-watchdog`

**Solution**: Create symlink to dev-kid CLI

```bash
# Option 1: Create symlink (requires sudo)
sudo ln -s /usr/local/bin/dev-kid /usr/local/bin/task-watchdog

# Option 2: Add to PATH (no sudo needed)
echo 'export PATH="$HOME/.dev-kid/cli:$PATH"' >> ~/.bashrc
source ~/.bashrc

# Verify it works
command -v task-watchdog
# Should output: /usr/local/bin/task-watchdog OR ~/.dev-kid/cli/dev-kid
```

**Test the fix**:
```bash
cd /tmp
mkdir test-project && cd test-project
git init
dev-kid init

cat > tasks.md << 'EOF'
- [ ] TASK-001: Test task affecting `test.py`
EOF

dev-kid orchestrate "Test"
# Should not crash anymore ✅
```

---

## The Three Other Fixes (Optional but Recommended)

### Fix 2: Add Startup Validation (5 min)

**File**: `cli/wave_executor.py`

Add after line 11 (after imports):

```python
import shutil

def validate_dependencies():
    """Ensure task-watchdog command is available"""
    if not shutil.which("task-watchdog") and not shutil.which("dev-kid"):
        print("❌ Error: task-watchdog command not found")
        print("")
        print("   Install dev-kid: ./scripts/install.sh")
        print("   Or: sudo ln -s /usr/local/bin/dev-kid /usr/local/bin/task-watchdog")
        sys.exit(1)
```

Add to line 19 (in `__init__`):

```python
def __init__(self, plan_file: str = "execution_plan.json"):
    validate_dependencies()  # Add this line
    self.plan_file = Path(plan_file)
    # ... rest of init
```

---

### Fix 3: Handle Missing tasks.md (5 min)

**File**: `cli/wave_executor.py`

Replace lines 57-64 (the `verify_wave_completion` function start):

```python
def verify_wave_completion(self, wave_id: int, tasks: List[Dict]) -> bool:
    """Verify all tasks in wave are marked complete in tasks.md"""

    # Add this check
    if not self.tasks_file.exists():
        print(f"❌ Error: tasks.md not found at {self.tasks_file}")
        print("   File may have been deleted during execution")
        return False

    try:
        content = self.tasks_file.read_text(encoding='utf-8')
    except Exception as e:
        print(f"❌ Error reading tasks.md: {e}")
        return False

    # ... rest of function unchanged
```

---

### Fix 4: Add Micro-Checkpoint Locking (10 min)

**File**: `cli/micro_checkpoint.py`

Add to imports (line 9):

```python
import fcntl
import time
```

Replace the entire `create_micro_checkpoint` function (lines 37-98):

```python
def create_micro_checkpoint(message: str = None, auto: bool = False) -> bool:
    """Create a micro-checkpoint with file locking to prevent race conditions"""

    # Acquire lock
    lock_file = Path(".git/dev-kid-checkpoint.lock")
    lock_fd = None

    for attempt in range(5):
        try:
            lock_fd = open(lock_file, 'w')
            fcntl.flock(lock_fd.fileno(), fcntl.LOCK_EX | fcntl.LOCK_NB)
            break
        except (BlockingIOError, IOError):
            if attempt == 4:
                print("   ⏳ Another checkpoint in progress")
                return False
            time.sleep(1)

    try:
        if not has_uncommitted_changes():
            print("   ℹ️  No changes to commit")
            return False

        changed_files = get_changed_files()

        if auto and not message:
            if len(changed_files) == 1:
                message = f"Update {changed_files[0]}"
            elif len(changed_files) <= 3:
                message = f"Update {', '.join(changed_files)}"
            else:
                message = f"Update {len(changed_files)} files"

        if not message:
            message = f"Micro-checkpoint {datetime.now().strftime('%H:%M:%S')}"

        subprocess.run(['git', 'add', '.'], check=True)

        commit_msg = f"""[MICRO-CHECKPOINT] {message}

{datetime.now().isoformat()}
Generated by: dev-kid micro-checkpoint
Files: {', '.join(changed_files[:5])}{'...' if len(changed_files) > 5 else ''}

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"""

        subprocess.run(['git', 'commit', '-m', commit_msg], check=True, capture_output=True)

        result = subprocess.run(['git', 'rev-parse', '--short', 'HEAD'],
                              capture_output=True, text=True, check=True)
        commit_hash = result.stdout.strip()

        print(f"   ✅ Micro-checkpoint: {commit_hash}")
        print(f"      {message}")

        return True

    finally:
        if lock_fd:
            fcntl.flock(lock_fd.fileno(), fcntl.LOCK_UN)
            lock_fd.close()
            lock_file.unlink(missing_ok=True)
```

---

## Test Everything

After applying fixes, run the test suite:

```bash
cd /home/gyasis/Documents/code/dev-kid
./test-ralph-edge-cases.sh
```

**Expected result**:
```
Total Tests: 15
Passed: 13-15 (87-100%)  ← up from 10 (67%)
Failed: 0-2 (0-13%)      ← down from 4 (27%)
```

---

## Quick Verification

### Test 1: Wave Executor Works

```bash
cd /tmp && mkdir wave-test && cd wave-test
git init
git config user.name "Test" && git config user.email "test@test.com"

cat > tasks.md << 'EOF'
- [ ] TASK-001: Create test.py
EOF

dev-kid orchestrate "Test Phase"
cat execution_plan.json  # Should show wave plan

# This should NOT crash anymore:
timeout 5s python3 /home/gyasis/Documents/code/dev-kid/cli/wave_executor.py || true
# Look for "✅ Task TASK-001 registered" (not FileNotFoundError)
```

### Test 2: Micro-Checkpoint Race Condition

```bash
cd /tmp/wave-test
echo "test1" > file1.txt
echo "test2" > file2.txt

# Start two checkpoints simultaneously
python3 /home/gyasis/Documents/code/dev-kid/cli/micro_checkpoint.py "First" &
python3 /home/gyasis/Documents/code/dev-kid/cli/micro_checkpoint.py "Second" &

wait

# Should see one success, one "Another checkpoint in progress"
git log --oneline | head -3
# Should show at least 1 micro-checkpoint commit
```

### Test 3: Missing tasks.md

```bash
cd /tmp && mkdir missing-test && cd missing-test
git init

cat > execution_plan.json << 'EOF'
{
  "execution_plan": {
    "phase_id": "Test",
    "waves": [{
      "wave_id": 1,
      "strategy": "PARALLEL_SWARM",
      "rationale": "Test",
      "tasks": [{"task_id": "T1", "instruction": "Test", "agent_role": "test"}],
      "checkpoint_after": {"enabled": true}
    }]
  }
}
EOF

# Don't create tasks.md
mkdir -p .claude memory-bank/private/$(whoami)

# Should show clear error (not crash):
timeout 5s python3 /home/gyasis/Documents/code/dev-kid/cli/wave_executor.py 2>&1 | grep "tasks.md not found"
# Should output: "❌ Error: tasks.md not found"
```

---

## Update Installation

After fixing the code, update the installation script:

**File**: `scripts/install.sh`

Add after line 75 (where dev-kid symlink is created):

```bash
# Create task-watchdog symlink
echo "Creating task-watchdog symlink..."
if [ -w /usr/local/bin ]; then
    ln -sf "$INSTALL_DIR/cli/dev-kid" /usr/local/bin/task-watchdog
    echo "   ✅ task-watchdog symlink created"
else
    echo "   ⚠️  Run: sudo ln -s $INSTALL_DIR/cli/dev-kid /usr/local/bin/task-watchdog"
fi
```

Then re-install:

```bash
./scripts/install.sh
command -v task-watchdog  # Verify
```

---

## Common Issues After Fixes

### "task-watchdog still not found"

**Cause**: Symlink not created or PATH not updated

**Fix**:
```bash
# Check if symlink exists
ls -l /usr/local/bin/task-watchdog

# If not, create manually
sudo ln -s /usr/local/bin/dev-kid /usr/local/bin/task-watchdog

# Or add to PATH
export PATH="$HOME/.dev-kid/cli:$PATH"
```

### "Wave executor still crashes"

**Cause**: Old Python bytecode cached

**Fix**:
```bash
# Remove cached bytecode
find ~/Documents/code/dev-kid/cli -name "*.pyc" -delete
find ~/Documents/code/dev-kid/cli -name "__pycache__" -type d -exec rm -rf {} +

# Try again
python3 cli/wave_executor.py
```

### "Micro-checkpoint locking doesn't work"

**Cause**: fcntl not available (Windows) or file system doesn't support locking

**Fix** (alternative implementation):
```python
# Use timestamp-based deduplication instead
def should_skip_recent_checkpoint() -> bool:
    try:
        result = subprocess.run(['git', 'log', '-1', '--format=%ct'],
                              capture_output=True, text=True, check=True)
        last_commit_time = int(result.stdout.strip())
        if time.time() - last_commit_time < 5:
            print("   ⏭️  Skipping (recent commit)")
            return True
    except:
        pass
    return False

def create_micro_checkpoint(message: str = None, auto: bool = False) -> bool:
    if should_skip_recent_checkpoint():
        return False
    # ... rest of function (no locking needed)
```

---

## Rollback Plan

If fixes break something:

```bash
# Restore backup
cp -r ~/.dev-kid.backup ~/.dev-kid

# Or reinstall from scratch
git checkout HEAD~1  # Go back one commit
./scripts/install.sh
```

---

## Next Steps

After applying fixes:

1. Run test suite (verify 13+ tests pass)
2. Test in real project (not just /tmp)
3. Document what you fixed in commit message
4. Update CHANGELOG.md
5. Tag release: `git tag v2.1-ralph-fixes`

---

## Questions?

**Where are the files?**
- Test report: `RALPH_EDGE_CASE_REPORT.md`
- Detailed fixes: `RALPH_SAFEGUARDS.md`
- Executive summary: `RALPH_TESTING_SUMMARY.md`
- Test script: `test-ralph-edge-cases.sh`

**What if I only have 5 minutes?**
- Just apply Fix 1 (task-watchdog symlink)
- Skip the optional fixes for now
- Wave executor will work (good enough for now)

**What if I don't have sudo access?**
- Use Option 2 (add to PATH) instead of symlink
- Add to ~/.bashrc: `export PATH="$HOME/.dev-kid/cli:$PATH"`
- Reload shell: `source ~/.bashrc`

---

End of quick fix guide.
